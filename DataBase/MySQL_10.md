# MySQL事务

事务用于保证数据的一致性，它由一组相关的dml语句组成，该组的dml语句要么全部成功，要么全部失败。如：转账就要用事务来处理，用以保证数据的一致性

事务和锁
当执行事务操作时（dml语句），mysql会在表上加锁，防止其它用户改表的数据，这对用户来讲是非常重要的



控制台事务的重要操作

start transaction --开始一个事务
savepoint 保存点名 --设置保存点
rollback to 保存点名 --回退事务
rollback --回退到事务开始的状态
commit -- 提交事务, 所有的操作生效, 不能回退

回退事务

保存点（savepoint)是事务中的点，用于取消分事务。当结束事务（commit）时，会自动的删除该事务所定义的所有保存点。
当执行回退事务（rollback）时，通过指定保存点可以回退到指定的点，并将中间的所有保存点删除

提交事务
使用commit语句可以提交事务.当执行了commit语句子后，会确认事务的变化、结束事务、删除保存点、释放锁，数据生效。当使用commit语包结束事务后，其他会话[其他连接]将可以查看到事务变化后的新数据[所有数据正式生效] ->和隔离级别有关



细节：

- 如果不开始事务，默认情况下，dml操作是自动提交的，不能回滚
- 如果开始一个事务，没有创建保存点，可以执行rollback，默认回退到事务开始的状态
- 可以在这个事务中(还没有提交时)，创建多个保存点.比如：savepoint aaa; 执行dml, savepoint bbb;
- 可以在事务没有提交前，选择回退到哪个保存点
- MySQL的事务机制需要InnoDB的存储引擎才可以使用，MyISAM不好使
- 开始一个事务的两种方式
  - ```start transaction```
  - ```setautocommit=off``` 不建议使用，设置了这个以后，所有会话就都开启事务了，而不是你自己的会话。autocommit=1：表示开启自动提交（默认行为）。 autocommit=0：表示关闭自动提交。



### 隔离级别

多个连接开启各自事务操作数据库中数据时，数据库系统要负责隔离操作，以保证各个连接在获取数据时的准确性。

隔离级别是跟事务相关的	离开事务就不要谈隔离级别

如果不考虑隔离性，可能会引发如下问题：脏读、不可重复读、幻读

* 脏读（dirty read）：当一个事务读取另一个事务**尚未提交**的修改时，产生脏读
* 不可重复读（nonrepeatable read）：同一查询在同一事务中多次进行，由于其
  他也提交事务所做的**修改或删除**，每次返回不同的结果集，此时发生不可重复读
* 幻读（phantom read）：同一查询在同一事务中多次进行，由于其他提交事务
  所做的**插入**操作，每次返回不同的结果集，此时发生幻读





MySQL事务隔离级别定义了事务与事务之间的隔离程度

| MySQL隔离级别              | 脏读 | 不可重复读 | 幻读 | 加锁读 |
| -------------------------- | ---- | ---------- | ---- | ------ |
| 读未提交(Read uncommitted) | √    | √          | √    | 不加锁 |
| 读已提交(Read committed)   | ×    | √          | √    | 不加锁 |
| 可重复读(Repeatable read)  | ×    | ×          | √    | 不加锁 |
| 可串行化(Serializable)     | ×    | ×          | ×    | 加锁   |

说明：√可能出现，×不会出现

注意，可重复度只能避免查询状态下的幻读，对于添加或删除操作，仍然会出现幻读 -> MVCC对幻读的解决是不彻底的

当我连接到数据库开启事务时， 其他用户的事务对我访问的该表格没有任何影响，除非我的事务提交了。 由于其他控制台添加数据是在我开始事务之后开始的，正常情况下我应该是读不到的。

修改隔离级别之前，控制台需要先commit





查看当前会话隔离级别 ```select @@tx_isolation;```，在新版本中是```select @@transaction_isolation;```；查看系统当前隔离级别 ```select @@global.tx_isolation;```

修改当前会话隔离级别（例如修改为Read uncommitted）

```SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED```

修改系统隔离级别

```SET GLOBAL TRANSACTION ISOLATION LEVEL 隔离级别```

MySQL默认的事务隔离级别是Repeatable read，一般情况下无特殊要求没必要修改（该级别已满足绝大多数项目要求）



```
#修改默认隔离级别，在my.ini可实现
transaction-isolation = 全局隔离级别

#可填参数：READ-UNCOMMITTED, READ-COMMITTED, REPEATABLE-READ, SERIALIZABLE
```

### 事务的acid特性

1.原子性（Atomicity）
原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。

2.一致性（Consistency）
事务必须使数据库从一个一致性状态变换到另外一个一致性状态

3.隔离性（Isolation）
事务的隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。

4.持久性（Durability)）
持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，
接下来即便数据库发生障也不应该对有任何影响
